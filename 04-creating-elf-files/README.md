# Creating Bare Metal ELF Files

We've got an idea of what an ELF file looks like, but we don't want to rely on a heavyweight toolchain to create one. Let's create one using only hex!

## Aims

- Create a reasonably minimal ELF file which can be re-used for our future hex programs
- Understand what parts of that ELF file will need to change per-program

## Writing a Minimal ELF Header

We've already seen that we can use `echo` to write binary files; for example, `echo -ne "\x30"` writes the value `0x30` (i.e. decimal 48, which is an ASCII `0`) to stdout. However, having to prefix everything with `\x` would be a pain, so we need an easier way to write hex and convert to binary. If you've not already, you'll probably want to read [guides/XXD_COMPILER.md](../guides/XXD_COMPILER.md) which explains how we'll write "hex" files.

Once you're comfortable with "compiling" hex files, take a look at `elfheader.hex` which contains a basic "baremetal hex" ELF file, and then `elfheader.smallsyms.hex` which goes slightly further in saving space. There are some small changes compared to the ELF file generated by the GNU toolchain:

- We removed the `strtab` section. There's no real need to have a second section since we're forced to have a `shstrtab` for section headers, and everything seems to work fine if we just re-use that.
- We removed a huge amount of padding. The code in the "GNU" ELF was placed at 0x1000 into the file, which is ~4kB of mostly empty space.
- We remove some seemingly pointless entries from the symbol table, leaving just a required null entry and the actual program's entry.

We leave a small amount of padding in the file for future changes, but mostly optimise for small size, and therefore also potentially quicker uploads onto hardware.

## Using the ELF Header

`elftemplate` is provided as a template for future programs. It must be changed to be useful, since the length of the program is replaced with `XX XX XX XX` in the template. This length occurs in the program header as well as in the `.text` section header.

To use `elftemplate` for a new program, copy it and replace the dummy program lengths with the actual little-endian hex length, and then append the hex program itself. You can add the program with `cat`, since the ELF header intentionally leaves the program at the end of the file. Finally, use our "xxd compiler" to create an ELF file:

```bash
cat elfheader.hex program.hex | sed "s/#.*$//g" | xxd -r -p > program.elf
```

## Next

We'll use the ELF header and write some raw RV32I machine code to utilise the UART device.